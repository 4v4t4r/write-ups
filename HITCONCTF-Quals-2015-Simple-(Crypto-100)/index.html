<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>HITCON CTF Quals 2015 - Simple (Crypto 100) &#8211; NUS Greyhats</title>
<meta name="description" content="HITCON CTF Quals 2015. Simple - Crypto 100">
<meta name="keywords" content="CTF, CRYPTO, HITCON, AES, CFB">

  

<!-- Twitter Cards -->
<meta name="twitter:title" content="HITCON CTF Quals 2015 - Simple (Crypto 100)">
<meta name="twitter:description" content="HITCON CTF Quals 2015. Simple - Crypto 100">



<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="//nusgreyhats.github.io/write-ups/images/icon.png">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="HITCON CTF Quals 2015 - Simple (Crypto 100)">
<meta property="og:description" content="HITCON CTF Quals 2015. Simple - Crypto 100">
<meta property="og:url" content="//nusgreyhats.github.io/write-ups/HITCONCTF-Quals-2015-Simple-(Crypto-100)/">
<meta property="og:site_name" content="NUS Greyhats">





<link rel="canonical" href="//nusgreyhats.github.io/write-ups/HITCONCTF-Quals-2015-Simple-(Crypto-100)/">
<link href="//nusgreyhats.github.io/write-ups/feed.xml" type="application/atom+xml" rel="alternate" title="NUS Greyhats Feed">

<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="//nusgreyhats.github.io/write-ups/assets/css/main.css">
<!-- Webfonts -->
<link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="//nusgreyhats.github.io/write-ups/assets/js/vendor/html5shiv.min.js"></script>
  <script src="//nusgreyhats.github.io/write-ups/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<link href="//nusgreyhats.github.io/write-ups/assets/css/font-awesome.css" rel="stylesheet" type="text/css">
<script src="//nusgreyhats.github.io/write-ups/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>


<!-- MathJax -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="//nusgreyhats.github.io/write-ups/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="//nusgreyhats.github.io/write-ups/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="//nusgreyhats.github.io/write-ups/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="//nusgreyhats.github.io/write-ups/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="//nusgreyhats.github.io/write-ups/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="//nusgreyhats.github.io/write-ups/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav class="main-nav-outer animated drop" id="site-nav"><!--main-nav-start-->
		    <ul class="main-nav">
		        <li class="small-logo"><a href="//nusgreyhats.github.io/write-ups/../#header"><img src="//nusgreyhats.github.io/write-ups/images/icon.png" alt=""></a></li>
		        <li><a href="//nusgreyhats.github.io/write-ups/">Write Ups</a></li>
		        <li><a href="//nusgreyhats.github.io/write-ups/../#security-wednesdays">Security Wednesdays</a></li>
		        <li><a href="//nusgreyhats.github.io/write-ups/../#the-ctf">The CTF</a></li>
		        <li><a href="//nusgreyhats.github.io/write-ups/../#team">Team</a></li>
		        <li><a href="//nusgreyhats.github.io/write-ups/../#contact">Contact</a></li>

		        
		        <li class="social">
		            <a href="https://facebook.com/groups/nusgreyhats/" class="facebook"><i class="fa fa-facebook"></i></a>
		        </li>
		        
		    </ul>
	</nav>
</div>
	
<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <span class="entry-tags"><a href="//nusgreyhats.github.io/write-ups/tags/#CTF" title="Pages tagged CTF">CTF</a>&nbsp;&bull;&nbsp;<a href="//nusgreyhats.github.io/write-ups/tags/#CRYPTO" title="Pages tagged CRYPTO">CRYPTO</a>&nbsp;&bull;&nbsp;<a href="//nusgreyhats.github.io/write-ups/tags/#HITCON" title="Pages tagged HITCON">HITCON</a>&nbsp;&bull;&nbsp;<a href="//nusgreyhats.github.io/write-ups/tags/#AES" title="Pages tagged AES">AES</a>&nbsp;&bull;&nbsp;<a href="//nusgreyhats.github.io/write-ups/tags/#CFB" title="Pages tagged CFB">CFB</a></span>
        
          <h1 class="entry-title">HITCON CTF Quals 2015 - Simple (Crypto 100)</h1>
        
      </header>
      <footer class="entry-meta">
        
          
              
          
              
          
              
                  
              
          
              
          
        
        
          <img src="//nusgreyhats.github.io/write-ups/images/bio-photo.jpg" class="bio-photo" alt="Quan Yang bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Quan Yang</span></span>
        <span class="entry-date date published"><time datetime="2015-10-19T00:00:00+08:00"><i class="fa fa-calendar-o"></i> October 19, 2015</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        <span class="social-share-twitter">
  <a href="https://twitter.com/intent/tweet?hashtags=CTF,CRYPTO,HITCON,AES,CFB&amp;text=HITCON%20CTF%20Quals%202015%20-%20Simple%20(Crypto%20100)&amp;url=//nusgreyhats.github.io/write-ups/HITCONCTF-Quals-2015-Simple-(Crypto-100)/&amp;via=https://twitter.com/quanyang" title="Share on Twitter" itemprop="Twitter"><i class="fa fa-twitter-square"></i> Tweet</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=//nusgreyhats.github.io/write-ups/HITCONCTF-Quals-2015-Simple-(Crypto-100)/" title="Share on Facebook" itemprop="Facebook"><i class="fa fa-facebook-square"></i> Like</a>
</span>
<span class="social-share-googleplus">
  <a href="https://plus.google.com/share?url=//nusgreyhats.github.io/write-ups/HITCONCTF-Quals-2015-Simple-(Crypto-100)/" title="Share on Google Plus" itemprop="GooglePlus"><i class="fa fa-google-plus-square"></i> +1</a>
</span>
<!-- /.social-share -->
        
      </footer>
      <div class="entry-content">
        <p>HITCON CTF Quals 2015 was from 17 October 2015, 10 am to 18 October 2015, 10pm. <a href="https://ctftime.org/event/245">CTFTIME Page</a>. Most of the challenges were very tedious, and this is one of the challenges that we solved (Although we only managed to solve this after the CTF ended).</p>

<h1 id="simple">Simple</h1>
<blockquote>
  <p><strong>Points:</strong> 100<br />
<strong>Category:</strong> Cryptography<br />
<strong>Description</strong>
Become admin!<br />
<a href="http://52.69.244.164:51913">http://52.69.244.164:51913</a><br />
<a href="//nusgreyhats.github.io/write-ups/resources/files/hitcon/simple/simple-01018f60e497b8180d6c92237e2b3a67.rb">simple-01018f60e497b8180d6c92237e2b3a67.rb</a><br />
<strong>md5</strong>: 4bd00c892d5e71f6d1d25d0bff2f49ec</p>
</blockquote>

<hr />

<h1 id="our-solution">Our solution</h1>

<p>Given the source code of the website, we’re told to get admin. Looking at the source code provided, to be able to print the flag out, we have to get the conditon r[‘admin’] to be equal to true.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">#!/usr/bin/env ruby

require &#39;sinatra/base&#39;
require &#39;sinatra/cookies&#39;
require &#39;openssl&#39;
require &#39;json&#39;

KEY = IO.binread(&#39;super-secret-key&#39;)
FLAG = IO.read(&#39;/home/simple/flag&#39;).strip

class SimpleApp &lt; Sinatra::Base
  helpers Sinatra::Cookies

  get &#39;/&#39; do
    auth = cookies[:auth]
    if auth
      begin
        auth = auth.b
        c = OpenSSL::Cipher.new(&#39;AES-128-CFB&#39;)
        c.decrypt
        c.key = KEY
        c.iv = auth[0...16]
        json = c.update(auth[16..-1]) + c.final
        r = JSON.parse(json)
        if r[&#39;admin&#39;] == true
          &quot;You&#39;re admin! The flag is #{FLAG}&quot;
        else
          &quot;Hi #{r[&#39;username&#39;]}, try to get admin?&quot;
        end
      rescue StandardError
        &#39;Something wrong QQ&#39;
      end
    else
      &lt;&lt;-EOS
&lt;html&gt;&lt;body&gt;&lt;form action=&#39;/&#39; method=&#39;POST&#39;&gt;
&lt;input type=&#39;text&#39; name=&#39;username&#39;/&gt;
&lt;input type=&#39;password&#39; name=&#39;password&#39;/&gt;
&lt;button type=&#39;submit&#39;&gt;register!&lt;/button&gt;
&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;
      EOS
    end
  end

  post &#39;/&#39; do
    username = params[&#39;username&#39;]
    password = params[&#39;password&#39;]
    if username &amp;&amp; password
      data = {
        username: username,
        password: password,
        db: &#39;hitcon-ctf&#39;
      }
      c = OpenSSL::Cipher.new(&#39;AES-128-CFB&#39;)
      c.encrypt
      c.key = KEY
      iv = c.random_iv
      json = JSON.dump(data)
      enc = c.update(json) + c.final
      cookies[:auth] = iv + enc
      redirect to(&#39;/&#39;)
    else
      &#39;Invalid input!&#39;
    end
  end
end</code></pre></div>

<p>It seems that the IV used as well as the encrypted json is kept in the client’s cookie, and that the same cookie is used to determine if you’re an admin. (This indicates that if we can spoof the encrypted json, we can become admin)</p>

<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/9d/CFB_encryption.svg/1202px-CFB_encryption.svg.png" alt="" />
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/57/CFB_decryption.svg/1202px-CFB_decryption.svg.png" alt="" /></p>

<p>AES-128 in CFB mode has a block size of 16 bytes.<br />
Simply put,<br />
Ciphertext of block #1 = E(IV, key) ^ Plaintext</p>

<p>Therefore, with knowledge of plaintext and ciphertext, we are able to obtain E(IV, key) and to forge for the first block of cipher text.</p>

<p>With a username and password of b, the Plaintext of the first block will be<br />
<code>{"username":"b",</code><br />
and we’ll use that knowledge to obtain our E(IV, key)  </p>

<p>This is our exploit script that forges our first block to be:
<code>{"admin": true }</code><br />
and allows us to obtain our flag!</p>

<div class="highlight"><pre><code class="language-python" data-lang="python">import requests
import urllib

def main():

    original_cookie = &quot;\xE9a\x89\xEC\xC7\x7C\xBC\x15\x92\xAD\xF8\x17\xF8\x40&quot; \
                      &quot;wV\xAB524\xF2\xF5UA\xE8\x1A\x29\xD4\xCB\xFA\xF6\xB3&quot; \
                      &quot;\x95h\x2B\x0D\xF4\xB9\xC8\xDB\xF8n\xB9o\xBES\x11d\xA3&quot; \
                      &quot;9\xA3c\x3Fi\xE7\xFA\x1C\xD0\xDBk\xDD\xD2_6\x06&quot;

    original_cookie = original_cookie.encode(&#39;hex&#39;)
    iv = original_cookie[0:32]
    first_16_byte_block = original_cookie[32:64]
    print &quot;IV: %s&quot; % iv
    print &quot;First Block: %s&quot; % first_16_byte_block

    #Plain text of first 16 byte block.
    plaintext =&#39;{&quot;username&quot;:&quot;b&quot;,&#39;

    encrypted_iv = int(plaintext.encode(&#39;hex&#39;),16) ^ int(first_16_byte_block,16)
    encrypted_iv = hex(encrypted_iv)[2:-1]
    print &quot;Encrypted IV: %s&quot; % encrypted_iv

    #The text I want to forge in the first block.
    forge_text = &#39;{&quot;admin&quot;: true }&#39;

    print &#39;Encrypting payload...&#39;

    payload = int(forge_text.encode(&#39;hex&#39;),16) ^ int(encrypted_iv,16)
    payload = hex(payload)[2:-1]
    payload = iv + payload
    print &quot;PAYLOAD: %s&quot; % payload

    cookie = {&quot;auth&quot;: payload.decode(&quot;hex&quot;)}
    r = requests.get(&quot;http://52.69.244.164:51913/&quot;, cookies=cookie)
    print &quot;Flag: %s&quot; % r.text

if __name__ == &quot;__main__&quot;:
    main()</code></pre></div>

<p>Running the script gives us:
<img src="//nusgreyhats.github.io/write-ups/resources/images/hitcon/simple/flag.png" alt="" /></p>

<p>And we have our flag: <strong>hitcon{WoW_CFB_m0dE_5o_eAsY}</strong></p>

        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'nusgreyhat';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="//nusgreyhats.github.io/write-ups/ASISCTF-Final-2015-Ultra-Compression-(Web-125)/" class="btn" title="ASIS CTF Finals 2015 - Ultra Compression (Web 125)">Previous</a>
      
      
        <a href="//nusgreyhats.github.io/write-ups/32C3-CTF-Flash-(Reversing-300)/" class="btn" title="32C3 CTF - Flash (Reversing 300)">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->



<footer class="footer">
	<div class="container">
		<span class="copyright">© NUS GreyHats • Theme By W3Goods</span>
		<div class="social-icons">
			
			<a href="https://facebook.com/groups/nusgreyhats/" title="NUS Greyhats on Facebook" target="_blank"><i class="fa fa-facebook-square fa-2x"></i></a>
			
			
			
			
			
			<a href="https://github.com/nusgreyhats" title="NUS Greyhats on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
			
			
			
			<a href="//nusgreyhats.github.io/write-ups/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
		</div><!-- /.social-icons -->
		<!--Copyright © 2014 Knight Theme By <a href="#">W3Goods</a>.-->
	</div>
</footer>


<script type="text/javascript">
  var BASE_URL = '//nusgreyhats.github.io/write-ups';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="//nusgreyhats.github.io/write-ups/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-67874722-1', 'auto');
  ga('send', 'pageview');

</script>



</body>
</html>
