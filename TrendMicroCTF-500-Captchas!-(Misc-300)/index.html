<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>TrendMicroCTF - 500 Captchas! (Misc 300) &#8211; NUS Greyhats</title>
<meta name="description" content="TrendMicro CTF 2015 Miscellaneous 300. Solve 500 Captchas.">
<meta name="keywords" content="CTF, MISC, CAPTCHA, TRENDMICRO">

  

<!-- Twitter Cards -->
<meta name="twitter:title" content="TrendMicroCTF - 500 Captchas! (Misc 300)">
<meta name="twitter:description" content="TrendMicro CTF 2015 Miscellaneous 300. Solve 500 Captchas.">



<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://nusgreyhats.org/write-ups/images/icon.png">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="TrendMicroCTF - 500 Captchas! (Misc 300)">
<meta property="og:description" content="TrendMicro CTF 2015 Miscellaneous 300. Solve 500 Captchas.">
<meta property="og:url" content="https://nusgreyhats.org/write-ups/TrendMicroCTF-500-Captchas!-(Misc-300)/">
<meta property="og:site_name" content="NUS Greyhats">





<link rel="canonical" href="https://nusgreyhats.org/write-ups/TrendMicroCTF-500-Captchas!-(Misc-300)/">
<link href="https://nusgreyhats.org/write-ups/feed.xml" type="application/atom+xml" rel="alternate" title="NUS Greyhats Feed">

<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="https://nusgreyhats.org/write-ups/assets/css/main.css">
<!-- Webfonts -->
<link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="https://nusgreyhats.org/write-ups/assets/js/vendor/html5shiv.min.js"></script>
  <script src="https://nusgreyhats.org/write-ups/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<link href="https://nusgreyhats.org/write-ups/assets/css/font-awesome.css" rel="stylesheet" type="text/css">
<script src="https://nusgreyhats.org/write-ups/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>


<!-- MathJax -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="https://nusgreyhats.org/write-ups/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="https://nusgreyhats.org/write-ups/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="https://nusgreyhats.org/write-ups/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://nusgreyhats.org/write-ups/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://nusgreyhats.org/write-ups/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://nusgreyhats.org/write-ups/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav class="main-nav-outer animated drop" id="site-nav"><!--main-nav-start-->
		    <ul class="main-nav">
		        <li class="small-logo"><a href="https://nusgreyhats.org/write-ups/../#header"><img src="https://nusgreyhats.org/write-ups/images/icon.png" alt=""></a></li>
		        <li><a href="https://nusgreyhats.org/write-ups/">Write Ups</a></li>
		        <li><a href="https://nusgreyhats.org/write-ups/../#security-wednesdays">Security Wednesdays</a></li>
		        <li><a href="https://nusgreyhats.org/write-ups/../#the-ctf">The CTF</a></li>
		        <li><a href="https://nusgreyhats.org/write-ups/../#team">Team</a></li>
		        <li><a href="https://nusgreyhats.org/write-ups/../#contact">Contact</a></li>

		        
		        <li class="social">
		            <a href="https://facebook.com/groups/nusgreyhats/" class="facebook"><i class="fa fa-facebook"></i></a>
		        </li>
		        
		    </ul>
	</nav>
</div>
	
<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <span class="entry-tags"><a href="https://nusgreyhats.org/write-ups/tags/#CTF" title="Pages tagged CTF">CTF</a>&nbsp;&bull;&nbsp;<a href="https://nusgreyhats.org/write-ups/tags/#MISC" title="Pages tagged MISC">MISC</a>&nbsp;&bull;&nbsp;<a href="https://nusgreyhats.org/write-ups/tags/#CAPTCHA" title="Pages tagged CAPTCHA">CAPTCHA</a>&nbsp;&bull;&nbsp;<a href="https://nusgreyhats.org/write-ups/tags/#TRENDMICRO" title="Pages tagged TRENDMICRO">TRENDMICRO</a></span>
        
          <h1 class="entry-title">TrendMicroCTF - 500 Captchas! (Misc 300)</h1>
        
      </header>
      <footer class="entry-meta">
        
          
              
          
              
          
              
                  
              
          
              
          
        
        
          <img src="https://nusgreyhats.org/write-ups/images/bio-photo.jpg" class="bio-photo" alt="Quan Yang bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Quan Yang</span></span>
        <span class="entry-date date published"><time datetime="2015-10-08T00:00:00+08:00"><i class="fa fa-calendar-o"></i> October 08, 2015</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        <span class="social-share-twitter">
  <a href="https://twitter.com/intent/tweet?hashtags=CTF,MISC,CAPTCHA,TRENDMICRO&amp;text=TrendMicroCTF%20-%20500%20Captchas!%20(Misc%20300)&amp;url=https://nusgreyhats.org/write-ups/TrendMicroCTF-500-Captchas!-(Misc-300)/&amp;via=https://twitter.com/quanyang" title="Share on Twitter" itemprop="Twitter"><i class="fa fa-twitter-square"></i> Tweet</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=https://nusgreyhats.org/write-ups/TrendMicroCTF-500-Captchas!-(Misc-300)/" title="Share on Facebook" itemprop="Facebook"><i class="fa fa-facebook-square"></i> Like</a>
</span>
<span class="social-share-googleplus">
  <a href="https://plus.google.com/share?url=https://nusgreyhats.org/write-ups/TrendMicroCTF-500-Captchas!-(Misc-300)/" title="Share on Google Plus" itemprop="GooglePlus"><i class="fa fa-google-plus-square"></i> +1</a>
</span>
<!-- /.social-share -->
        
      </footer>
      <div class="entry-content">
        <h1>Welcome to Captcha Challenge!</h1>
<p>The challenge description was a website, upon entering the website, you are allowed to register/sign in.</p>
<hr />

<p>
	After registering and logging in, you are shown a captcha, and it seems that the challenge was to solve 500 consecutive captchas without any mistakes. However, it seems that you are able to skip captchas by refreshing the page (this turned out to be very useful).<br /><br />
	Captchas looks like this:
</p>
<center><img src="/write-ups/resources/images/captcha.png" width="30%" height="30%" /><img src="/write-ups/resources/images/captcha2.png" width="30%" height="30%" /></center>
<p>
	To automatically solve all 500 captchas, we wrote a python script using the Python Imaging Library. The trick to solving the captchas was to do some pre-processing and to build a dataset of good characters which we will be using to solve new captchas.	
	<br />
	<h3>Processing</h3>
	<b>Turn background/noise to white, and text to black</b>
	Scan the entire picture and rank the colours by frequency, the background colour would have the highest frequency followed by the text
</p>
<center><img src="/write-ups/resources/images/processed.jpg" width="30%" height="30%" /></center>
<p>
	<b>Dynamically slice the image by characters</b>
  For each X coordinate, if the Y coordinates along the X coordinate has a black pixel:<br />
  set inLetter = true<br />
  Keep going along X until you reach a X where there is no black pixel along it, then you have your starting and ending x coordinate for your character!
</p>

<div class="highlight"><pre><code class="language-python" data-lang="python">for y in range(im2.size[0]): # slice across
  for x in range(im2.size[1]): # slice down
    pix = im2.getpixel((y,x))
    if pix != 255:
      inletter = True
      last = y
  if foundletter == False and inletter == True:
    foundletter = True
    start = y

  if foundletter == True and inletter == False:
    end = y
    if end-last &gt; 3 and end-start &gt; 20:
      foundletter=False
      letters.append((start-3,end))
  inletter=False</code></pre></div>

<p>
    With that, you can build a dataset of characters to use for comparison:
</p>
<center><img src="/write-ups/resources/images/dataset.png" width="25%" height="25%" /></center>
<p>
	So now, we process new captchas similarly, and slice them up into characters for comparison with our dataset.<br />
	The code for comparison is as follows:
</p>

<div class="highlight"><pre><code class="language-python" data-lang="python">class VectorCompare:
  def magnitude(self,concordance):
    total = 0
    for word,count in concordance.iteritems():
      total += count ** 2
    return math.sqrt(total)

  def relation(self,concordance1, concordance2):
    relevance = 0
    topvalue = 0
    for word, count in concordance1.iteritems():
      if concordance2.has_key(word):
        topvalue += count * concordance2[word]
    return topvalue / (self.magnitude(concordance1) * self.magnitude(concordance2))

def buildvector(im):
  d1 = {}

  count = 0
  for i in im.getdata():
    d1[count] = i
    count += 1

  return d1

def crack(img):
  im = img
  im = im.convert(&quot;RGBA&quot;)
  his = im.load()
  v = VectorCompare()

  imageset = []

  for img in os.listdir(&#39;./iconset4/&#39;):
    temp = []
    if img != &quot;Thumbs.db&quot; and img != &quot;.DS_Store&quot;: # windows check...
      imgs = Image.open(&quot;./iconset4/%s&quot;%(img))
      imgs = imgs.convert(&quot;P&quot;)
      temp.append(buildvector(imgs))
    imageset.append({img[0:2]:temp})


  values = {}

  for y in xrange(im.size[1]):
      for x in xrange(im.size[0]):
        values[x,y] = his[x,y]

  count = {}
  for j,k in sorted(values.items(), key=itemgetter(1), reverse=True):
    if (k &gt; 0 ):
      if k in count:
        count[k] = count[k]+1
      else:
        count[k] = 1

  a = sorted(count.items(), key=itemgetter(1), reverse=True)
  text = a[1][0]
  im2 = Image.new(&quot;P&quot;,im.size,255)


  for x in range(im.size[1]):
    for y in range(im.size[0]):
      pix = im.getpixel((y,x))
      if pix == text:
        pix = (0,0,0,0)
      else:
        pix = (255,255,255,255)
      im2.putpixel((y,x),pix[2])

  guessword = &quot;&quot;
  letters =[]
  inletter = False
  foundletter=False
  start = 0
  end = 0
  last = 0
  for y in range(im2.size[0]): # slice across
    for x in range(im2.size[1]): # slice down
      pix = im2.getpixel((y,x))
      if pix != 255:
        inletter = True
        last = y
    if foundletter == False and inletter == True:
      foundletter = True
      start = y

    if foundletter == True and inletter == False:
      end = y
      if end-last &gt; 3 and end-start &gt; 20:
        foundletter=False
        letters.append((start-3,end))
    inletter=False

  results = []
  for letter in letters:
    m = hashlib.md5()
    img4 = im2.crop(( letter[0] , 0, letter[1],im2.size[1] ))
    guess = []
    for image in imageset:
      for x,y in image.iteritems():
        if len(y) != 0:
          guess.append( ( v.relation(y[0],buildvector(img4)),x.decode(&#39;hex&#39;)) )
    guess.sort(reverse=True)
    results.append(guess[0])

  return results

def main():
  img= Image.open(&quot;image.png&quot;)
  print crack(img)
  
if __name__ == &quot;__main__&quot;:
    main()</code></pre></div>

<p>
  To achieve a 100% accuracy, we need to reject certain solutions that contains risk, to do this, we reject a solution if any of the characters has a similarity score that is less that 0.99. With this, we were able to achieve a 100% accuracy with a rejection rate of ~1 per captcha.
  <center><img src="/write-ups/resources/images/captcharesults.png" width="50%" height="50%" /></center>
  
  After about ~2 hours, our script finally solve all 500 captchas.
  <center><img src="/write-ups/resources/images/flag.png" width="50%" height="50%" /></center>
</p>

<p><br /></p>

<p>And we have our flag: <b>TMCTF{217dae3fd34cee799658d4552e37827f}</b></p>


        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'nusgreyhat';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="https://nusgreyhats.org/write-ups/Capture-The-Flag-101-Workshop/" class="btn" title="Capture The Flag 101 Workshop">Previous</a>
      
      
        <a href="https://nusgreyhats.org/write-ups/TrendMicroCTF-VirusClicker-(Offensive-200)/" class="btn" title="TrendMicroCTF - VirusClicker (Offensive 200)">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->



<footer class="footer">
	<div class="container">
		<span class="copyright">© NUS GreyHats • Theme By W3Goods</span>
		<div class="social-icons">
			
			<a href="https://facebook.com/groups/nusgreyhats/" title="NUS Greyhats on Facebook" target="_blank"><i class="fa fa-facebook-square fa-2x"></i></a>
			
			
			
			
			
			<a href="https://github.com/nusgreyhats" title="NUS Greyhats on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
			
			
			
			<a href="https://nusgreyhats.org/write-ups/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
		</div><!-- /.social-icons -->
		<!--Copyright © 2014 Knight Theme By <a href="#">W3Goods</a>.-->
	</div>
</footer>


<script type="text/javascript">
  var BASE_URL = 'https://nusgreyhats.org/write-ups';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://nusgreyhats.org/write-ups/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-67874722-1', 'auto');
  ga('send', 'pageview');

</script>



</body>
</html>
