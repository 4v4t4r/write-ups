<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>32C3 CTF - Flash (Reversing 300) &#8211; NUS Greyhats</title>
<meta name="description" content="32C3 CTF - Flash. Reversing - 300 Points">
<meta name="keywords" content="CTF, REVERSING, 32C3, REGEX">

  

<!-- Twitter Cards -->
<meta name="twitter:title" content="32C3 CTF - Flash (Reversing 300)">
<meta name="twitter:description" content="32C3 CTF - Flash. Reversing - 300 Points">



<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="//nusgreyhats.github.io/write-ups/images/icon.png">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="32C3 CTF - Flash (Reversing 300)">
<meta property="og:description" content="32C3 CTF - Flash. Reversing - 300 Points">
<meta property="og:url" content="//nusgreyhats.github.io/write-ups/32C3-CTF-Flash-(Reversing-300)/">
<meta property="og:site_name" content="NUS Greyhats">





<link rel="canonical" href="//nusgreyhats.github.io/write-ups/32C3-CTF-Flash-(Reversing-300)/">
<link href="//nusgreyhats.github.io/write-ups/feed.xml" type="application/atom+xml" rel="alternate" title="NUS Greyhats Feed">

<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="//nusgreyhats.github.io/write-ups/assets/css/main.css">
<!-- Webfonts -->
<link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="//nusgreyhats.github.io/write-ups/assets/js/vendor/html5shiv.min.js"></script>
  <script src="//nusgreyhats.github.io/write-ups/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<link href="//nusgreyhats.github.io/write-ups/assets/css/font-awesome.css" rel="stylesheet" type="text/css">
<script src="//nusgreyhats.github.io/write-ups/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>


<!-- MathJax -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="//nusgreyhats.github.io/write-ups/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="//nusgreyhats.github.io/write-ups/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="//nusgreyhats.github.io/write-ups/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="//nusgreyhats.github.io/write-ups/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="//nusgreyhats.github.io/write-ups/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="//nusgreyhats.github.io/write-ups/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav class="main-nav-outer animated drop" id="site-nav"><!--main-nav-start-->
		    <ul class="main-nav">
		        <li class="small-logo"><a href="//nusgreyhats.github.io/write-ups/../#header"><img src="//nusgreyhats.github.io/write-ups/images/icon.png" alt=""></a></li>
		        <li><a href="//nusgreyhats.github.io/write-ups/">Write Ups</a></li>
		        <li><a href="//nusgreyhats.github.io/write-ups/../#security-wednesdays">Security Wednesdays</a></li>
		        <li><a href="//nusgreyhats.github.io/write-ups/../#the-ctf">The CTF</a></li>
		        <li><a href="//nusgreyhats.github.io/write-ups/../#team">Team</a></li>
		        <li><a href="//nusgreyhats.github.io/write-ups/../#contact">Contact</a></li>

		        
		        <li class="social">
		            <a href="https://facebook.com/groups/nusgreyhats/" class="facebook"><i class="fa fa-facebook"></i></a>
		        </li>
		        
		    </ul>
	</nav>
</div>
	
<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <span class="entry-tags"><a href="//nusgreyhats.github.io/write-ups/tags/#CTF" title="Pages tagged CTF">CTF</a>&nbsp;&bull;&nbsp;<a href="//nusgreyhats.github.io/write-ups/tags/#REVERSING" title="Pages tagged REVERSING">REVERSING</a>&nbsp;&bull;&nbsp;<a href="//nusgreyhats.github.io/write-ups/tags/#32C3" title="Pages tagged 32C3">32C3</a>&nbsp;&bull;&nbsp;<a href="//nusgreyhats.github.io/write-ups/tags/#REGEX" title="Pages tagged REGEX">REGEX</a></span>
        
          <h1 class="entry-title">32C3 CTF - Flash (Reversing 300)</h1>
        
      </header>
      <footer class="entry-meta">
        
          
              
          
              
          
              
                  
              
          
              
          
        
        
          <img src="//nusgreyhats.github.io/write-ups/images/bio-photo.jpg" class="bio-photo" alt="Quan Yang bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Quan Yang</span></span>
        <span class="entry-date date published"><time datetime="2015-12-31T00:00:00+08:00"><i class="fa fa-calendar-o"></i> December 31, 2015</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        <span class="social-share-twitter">
  <a href="https://twitter.com/intent/tweet?hashtags=CTF,REVERSING,32C3,REGEX&amp;text=32C3%20CTF%20-%20Flash%20(Reversing%20300)&amp;url=//nusgreyhats.github.io/write-ups/32C3-CTF-Flash-(Reversing-300)/&amp;via=https://twitter.com/quanyang" title="Share on Twitter" itemprop="Twitter"><i class="fa fa-twitter-square"></i> Tweet</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=//nusgreyhats.github.io/write-ups/32C3-CTF-Flash-(Reversing-300)/" title="Share on Facebook" itemprop="Facebook"><i class="fa fa-facebook-square"></i> Like</a>
</span>
<span class="social-share-googleplus">
  <a href="https://plus.google.com/share?url=//nusgreyhats.github.io/write-ups/32C3-CTF-Flash-(Reversing-300)/" title="Share on Google Plus" itemprop="GooglePlus"><i class="fa fa-google-plus-square"></i> +1</a>
</span>
<!-- /.social-share -->
        
      </footer>
      <div class="entry-content">
        <p>32C3 CTF is organized along with the Chaos Communication Congress in Hamburg, it started on Dec. 27, 20:00 UTC and lasted 48h until Dec. 29, 20:00 UTC.</p>

<h1 id="flash">Flash</h1>
<blockquote>
  <p><strong>Points:</strong> 300<br />
<strong>Category:</strong> Reversing<br />
<strong>Description</strong>
This <a href="https://32c3ctf.ccc.ac/uploads/flash.tgz">firmware image</a> is secured against manipulation using RSA and MD5. Can you still get around that protection? <br />
The service is available <a href="http://136.243.194.37:8001/upload.py">here</a>.</p>
</blockquote>

<hr />

<h1 id="our-solution">Our solution</h1>

<p><img src="//nusgreyhats.github.io/write-ups/resources/images/32c3ctf/firmware-upload.png" alt="" width="50%" /></p>

<p>Weâ€™re given a gzip compressed file, which includes a sample firmware, the public key and the firmware uploading service backend script.</p>

<p><img src="//nusgreyhats.github.io/write-ups/resources/images/32c3ctf/firmware-bin.png" alt="" width="50%" /></p>

<p>Running file on the firmware.bin shows that it is an archive. The signature file contained in it seems to be a digital signature that is used to ensure the authenticity of the firmware.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">$ file firmware.bin
firmware.bin: POSIX tar archive (GNU)
$ tar vxf firmware.bin
x ./CHANGELOG
x ./firmware.img
x ./install
x ./LICENSE
x ./README
x signature</code></pre></div>

<p>We now take a look at the uploading service.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python">#!/usr/bin/env python2
import cgi
import cgitb; cgitb.enable()
import os, sys
import subprocess
import re
from Crypto.Signature import PKCS1_v1_5
from Crypto.PublicKey import RSA
from Crypto.Hash import MD5
from IPython import embed

class MD5_32C3:
  oid = MD5.new().oid
  def __init__(self, digest):
    self._digest_data = digest
  def digest(self):
    return self._digest_data

UPLOAD_DIR = &quot;/tmp&quot;

HTML_FORM_TEMPLATE = &quot;&quot;&quot;
**truncated**
&lt;form action=&quot;&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;
File: &lt;input name=&quot;file&quot; type=&quot;file&quot;&gt;&lt;br&gt;
&lt;input name=&quot;submit&quot; type=&quot;submit&quot; value=&quot;upload!&quot;&gt;
&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;&quot;&quot;&quot;

HTML_STATUS_TEMPLATE = &quot;&quot;&quot;
**truncated**
&lt;h1&gt;Firmware Update Status&lt;/h1&gt;
%(status)s
&lt;/body&gt;
&lt;/html&gt;&quot;&quot;&quot;

def print_html_form():
    print &quot;content-type: text/html\n&quot;
    print HTML_FORM_TEMPLATE

def print_html_status(status):
    print &quot;content-type: text/html\n&quot;
    print HTML_STATUS_TEMPLATE % {&#39;status&#39;: status}

def save_firmware_image():
    form = cgi.FieldStorage()
    if int(os.environ[&#39;CONTENT_LENGTH&#39;]) &gt; 2**22:
      return False
    if not form.has_key(&#39;file&#39;):
      return False
    fileitem = form[&#39;file&#39;]
    if not fileitem.file:
      return False

    filename = os.urandom(32).encode(&quot;hex&quot;)
    filename = os.path.join(UPLOAD_DIR, filename)

    fout = file(filename + &#39;.bin&#39;, &#39;wb&#39;)
    while 1:
      chunk = fileitem.file.read(100000)
      if not chunk: break
      fout.write(chunk)
    fout.close()
    return filename

def calc_md5(filename):
    cmd = &#39;mkdir &#39; + filename + &#39;; cd &#39; + filename + &#39;; md5calc &lt; &#39; + filename + &#39;.bin | tar xv&#39;
    result = subprocess.Popen(cmd, shell=True, stderr=subprocess.PIPE, stdout=subprocess.PIPE).communicate()[1]
    return re.search(&#39;[a-f0-9]{32}&#39;, result).group(0).decode(&#39;hex&#39;)

def verify_sig(filename, expected_md5):
    try:
      signature = open(filename + &#39;/signature&#39;).read()
    except:
      return False,&#39;No signature found!&#39;
    try:
      pubkey = RSA.importKey(open(&#39;../rsa2048pub.pem&#39;).read())
    except:
      return False,&#39;No pubkey found!&#39;
    expected_md5 = MD5_32C3(expected_md5)
    verifier = PKCS1_v1_5.new(pubkey)
    return verifier.verify(expected_md5, signature),None

if os.environ[&#39;REQUEST_METHOD&#39;] == &#39;GET&#39;:
    print_html_form()

if os.environ[&#39;REQUEST_METHOD&#39;] == &#39;POST&#39;:
    filename = save_firmware_image()
    if not filename:
      print_html_status(&#39;Invalid data received!&#39;)
      sys.exit(0)
    md5 = calc_md5(filename)
    status,msg = verify_sig(filename, md5)
    if status:
      msg = &#39;Signature check successul! Updating firmware... &lt;br&gt;&#39;
      cmd = &#39;cd &#39; + filename + &#39;; ./install&#39;
      result = subprocess.Popen(cmd, shell=True, stderr=subprocess.PIPE, stdout=subprocess.PIPE).communicate()[1]
      msg = msg + result + &#39;&lt;br&gt;done.&#39;
    if not status and not msg:
      msg = &#39;Signature check failed!&#39;
    print_html_status(msg)</code></pre></div>

<p>From the python script, we can tell that the verification process is as follows:
encrypt(md5(firmware.bin),public_key) == signature</p>

<p>The other interesting finding is the command <code>cmd = 'cd ' + filename + '; ./install'</code>. This tells us that weâ€™ll have to modify the file <code>install</code> to run arbitrary code in order to get the flag.</p>

<p>Simply modifying the firmware will not work, we need to find a way to bypass the signature check. As it is a reversing challenge, and that the RSA key is 2048-bits, I did not attempt to go towards the cryptography direction. 
Instead, what is interesting is the calc_md5 function.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python">def calc_md5(filename):
    cmd = &#39;mkdir &#39; + filename + &#39;; cd &#39; + filename + &#39;; md5calc &lt; &#39; + filename + &#39;.bin | tar xv&#39;
    result = subprocess.Popen(cmd, shell=True, stderr=subprocess.PIPE, stdout=subprocess.PIPE).communicate()[1]
    return re.search(&#39;[a-f0-9]{32}&#39;, result).group(0).decode(&#39;hex&#39;)</code></pre></div>

<p>The function uses regular expression to obtain the MD5 from the output of the subprocess command, and what is interesting is that it takes the first occurance of a 32-characters a-f0-9 string as the MD5 hash (due to <code>re.search().group(0)</code>).</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">$ ./md5calc &lt; firmware.bin | tar xv
name: ./CHANGELOG, size: 1812
name: ./firmware.img, size: 1048576
./CHANGELOG
./firmware.img
name: ./install, size: 44
name: ./LICENSE, size: 576
name: ./README, size: 930
name: signature, size: 256
nb override: 512
nb override: 512
md5: a0e3c9c3262ccf420c789ed55148412c
./install
./LICENSE
./README
signature</code></pre></div>

<p>We see that if the firmware archive contains a file with the name of <code>a0e3c9c3262ccf420c789ed55148412c</code>, the calc_md5 will take that as the md5 hash instead of the actual md5 hash.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">$ ls -la firmware3
total 4152
drwxr-xr-x 1 vagrant vagrant     374 Dec 31  2015 .
drwx------ 1 vagrant vagrant     714 Dec 31 10:56 ..
-rw-r--r-- 1 vagrant vagrant    6148 Dec 29 13:48 .DS_Store
-rw-r--r-- 1 vagrant vagrant 1055232 Dec 29 13:48 CHANGELOG
-rw-r--r-- 1 vagrant vagrant     576 Dec 26 22:37 LICENSE
-rw-r--r-- 1 vagrant vagrant     930 Dec 26 22:37 a0e3c9c3262ccf420c789ed55148412c
-rw-r--r-- 1 vagrant vagrant 1048576 Dec 26 22:37 firmware.img
-rw-r--r-- 1 vagrant vagrant 2114048 Dec 29 13:53 firmware3.bin
-rwxr-xr-x 1 vagrant vagrant      48 Dec 29 13:45 install
-rw-r--r-- 1 vagrant vagrant    2278 Dec 29 13:51 out.txt
-rw-r--r-- 1 vagrant vagrant     256 Dec 29 13:28 signature

$ python test.py firmware3
name: CHANGELOG, size: 1055232
name: LICENSE, size: 576
name: a0e3c9c3262ccf420c789ed55148412c, size: 930
name: firmware.img, size: 1048576
name: install, size: 48
name: signature, size: 256
nb override: 512
nb override: 512
md5: 8de5e3801c7758ba5e632b7c84533e8b

a0e3c9c3262ccf420c789ed55148412c
Signature check successul! Updating firmware... &lt;br&gt;&lt;br&gt;done.</code></pre></div>

<p>With that, we can make use of multiple ways to obtain the flag located at <code>/home/challenge/flag.txt</code>. For me, I made use of nc to send the flag back.</p>

<p><img src="//nusgreyhats.github.io/write-ups/resources/images/32c3ctf/flag.png" alt="" width="100%" /></p>

<p>Hurray!</p>

        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'nusgreyhat';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="//nusgreyhats.github.io/write-ups/HITCONCTF-Quals-2015-Simple-(Crypto-100)/" class="btn" title="HITCON CTF Quals 2015 - Simple (Crypto 100)">Previous</a>
      
      
        <a href="//nusgreyhats.github.io/write-ups/INSOMNIHACK-CTF-Teaser-2016-Write-Up-Smartcat1/" class="btn" title="INSOMNIHACK CTF Teaser 2016 Write Up - Smartcat1">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->



<footer class="footer">
	<div class="container">
		<span class="copyright">Â© NUS GreyHats â€¢ Theme By W3Goods</span>
		<div class="social-icons">
			
			<a href="https://facebook.com/groups/nusgreyhats/" title="NUS Greyhats on Facebook" target="_blank"><i class="fa fa-facebook-square fa-2x"></i></a>
			
			
			
			
			
			<a href="https://github.com/nusgreyhats" title="NUS Greyhats on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
			
			
			
			<a href="//nusgreyhats.github.io/write-ups/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
		</div><!-- /.social-icons -->
		<!--Copyright Â© 2014 Knight Theme By <a href="#">W3Goods</a>.-->
	</div>
</footer>


<script type="text/javascript">
  var BASE_URL = '//nusgreyhats.github.io/write-ups';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="//nusgreyhats.github.io/write-ups/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-67874722-1', 'auto');
  ga('send', 'pageview');

</script>



</body>
</html>
